{% extends "base.html" %}

{% block title %}Reset Password - InsightBlog{% endblock %}

{% block content %}
<div class="container container-sm" style="padding: 4rem 0;">
    <div class="card card-glass" style="max-width: 450px; margin: 0 auto;">
        <div class="text-center mb-lg">
            <h2 style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                Reset Password
            </h2>
            <p class="text-muted">Enter your OTP and new password</p>
        </div>

        <form id="resetForm" class="flex flex-col gap-md">
            <input type="hidden" id="email" name="email">
            
            <div>
                <label for="otp" class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">OTP Code</label>
                <input 
                    id="otp" 
                    name="otp" 
                    type="text" 
                    required 
                    class="input"
                    placeholder="Enter 6-digit code"
                    autocomplete="off"
                >
            </div>

            <div>
                <label for="new_password" class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">New Password</label>
                <input 
                    id="new_password" 
                    name="new_password" 
                    type="password" 
                    required 
                    class="input"
                    placeholder="••••••••"
                    autocomplete="new-password"
                    minlength="6"
                >
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 0.5rem;">
                <span id="submit-text">Reset Password</span>
                <span id="submit-spinner" class="animate-pulse" style="display: none;">Resetting...</span>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get email from URL query params
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    if (email) {
        document.getElementById('email').value = email;
    } else {
        notificationService.showToast('Email missing from URL', 'error');
    }

    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Show loading state
        const submitBtn = e.target.querySelector('button[type="submit"]');
        document.getElementById('submit-text').style.display = 'none';
        document.getElementById('submit-spinner').style.display = 'inline';
        submitBtn.disabled = true;

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('/api/v1/users/reset-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                notificationService.showToast('Password reset successful!', 'success');
                setTimeout(() => window.location.href = '/login', 2000);
            } else {
                const errorData = await response.json();
                notificationService.showToast(errorData.detail || 'Reset failed', 'error');
                
                // Reset button on error
                document.getElementById('submit-text').style.display = 'inline';
                document.getElementById('submit-spinner').style.display = 'none';
                submitBtn.disabled = false;
            }
        } catch (error) {
            notificationService.showToast('An error occurred', 'error');
            
            // Reset button on error
            document.getElementById('submit-text').style.display = 'inline';
            document.getElementById('submit-spinner').style.display = 'none';
            submitBtn.disabled = false;
        }
    });
</script>
{% endblock %}
