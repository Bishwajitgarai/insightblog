{% extends "base.html" %}

{% block title %}Post - InsightBlog{% endblock %}

{% block content %}
<div class="container mx-auto max-w-4xl">
    <!-- Loading -->
    <div id="loading" class="text-center py-10">
        <p class="text-gray-500">Loading post...</p>
    </div>

    <!-- Post Content -->
    <div id="post-content" class="hidden">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="/dashboard" class="text-gray-400 hover:text-primary transition">← Back to Feed</a>
        </div>

        <article class="card mb-8">
            <div id="post-image" class="hidden w-full h-96 bg-gray-800 mb-6 rounded-lg overflow-hidden">
                <img id="post-img" src="" alt="" class="w-full h-full object-cover">
            </div>

            <div class="mb-6">
                <h1 id="post-title" class="text-4xl font-bold neon-text mb-4"></h1>
                <div class="flex items-center text-sm text-gray-500 space-x-4">
                    <span id="post-author"></span>
                    <span>•</span>
                    <span id="post-date"></span>
                </div>
            </div>

            <div class="prose prose-invert max-w-none mb-8">
                <p id="post-summary" class="text-lg text-gray-300"></p>
            </div>

            <div id="post-categories" class="flex flex-wrap gap-2 mb-6"></div>

            <div class="flex items-center space-x-6 pt-6 border-t border-gray-800">
                <button id="like-btn" onclick="toggleLike()" class="flex items-center space-x-2 hover:text-primary transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                    <span id="like-count">0</span>
                </button>

                <div class="flex items-center space-x-2 text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span id="comment-count">0</span>
                </div>

                <button onclick="sharePost()" class="flex items-center space-x-2 hover:text-secondary transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    <span>Share</span>
                </button>

                <div id="admin-actions" class="ml-auto flex space-x-2 hidden">
                    <button onclick="deletePost()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition">Delete</button>
                </div>
            </div>
        </article>

        <!-- Comments Section -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-6">Comments (<span id="comments-count">0</span>)</h2>

            <form id="comment-form" class="mb-8">
                <textarea id="comment-content" rows="3" placeholder="Write a comment..." 
                          class="w-full px-4 py-3 bg-bg border border-gray-700 rounded-lg focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50 transition mb-3"></textarea>
                <div class="flex justify-end">
                    <button type="submit" class="btn-neon px-6 py-2">Post Comment</button>
                </div>
            </form>

            <div id="comments-list" class="space-y-6"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get post ID from URL
    const postId = parseInt(window.location.pathname.split('/').pop());
    let postData = null;
    let userLiked = false;

    async function loadPost() {
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}`);
            if (!response.ok) throw new Error('Post not found');
            
            postData = await response.json();
            renderPost(postData);
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('post-content').classList.remove('hidden');
        } catch (error) {
            document.getElementById('loading').innerHTML = '<p class="text-red-500">Error loading post</p>';
        }
    }

    function renderPost(post) {
        document.getElementById('post-title').textContent = post.title;
        document.getElementById('post-author').textContent = `By ${post.author_name}`;
        document.getElementById('post-date').textContent = new Date(post.created_at).toLocaleDateString();
        document.getElementById('post-summary').textContent = post.summary;
        document.getElementById('like-count').textContent = post.like_count;
        document.getElementById('comment-count').textContent = post.comment_count;
        document.getElementById('comments-count').textContent = post.comment_count;
        
        if (post.image_url) {
            document.getElementById('post-image').classList.remove('hidden');
            document.getElementById('post-img').src = post.image_url;
            document.getElementById('post-img').alt = post.title;
        }
        
        userLiked = post.user_liked;
        const likeBtn = document.getElementById('like-btn').querySelector('svg');
        if (userLiked) {
            likeBtn.classList.add('fill-primary', 'text-primary');
        }
        
        // Render categories and tags
        const catContainer = document.getElementById('post-categories');
        post.categories.forEach(cat => {
            catContainer.innerHTML += `<span class="px-3 py-1 bg-primary/20 text-primary rounded-full text-sm">${cat.title}</span>`;
        });
        post.tags.forEach(tag => {
            catContainer.innerHTML += `<span class="px-3 py-1 bg-secondary/20 text-secondary rounded-full text-sm">#${tag.title}</span>`;
        });
        
        // Render comments
        renderComments(post.comments);
    }

    function renderComments(comments) {
        const container = document.getElementById('comments-list');
        container.innerHTML = '';
        
        comments.forEach(comment => {
            const commentHtml = `
                <div class="border-l-2 border-gray-700 pl-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-semibold text-primary">${comment.author_name}</span>
                            <span class="text-xs text-gray-500 ml-2">${new Date(comment.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                    <p class="text-gray-300 mb-3">${comment.content}</p>
                    <button onclick="showReplyForm(${comment.id})" class="text-xs text-secondary hover:text-primary transition">Reply</button>
                    
                    <div id="reply-form-${comment.id}" class="hidden mt-4 ml-4">
                        <textarea id="reply-content-${comment.id}" rows="2" placeholder="Write a reply..." 
                                  class="w-full px-3 py-2 bg-bg border border-gray-700 rounded-lg focus:border-primary focus:outline-none mb-2 text-sm"></textarea>
                        <div class="flex justify-end space-x-2">
                            <button onclick="cancelReply(${comment.id})" class="px-3 py-1 text-sm text-gray-400 hover:text-white">Cancel</button>
                            <button onclick="postReply(${comment.id})" class="px-3 py-1 text-sm bg-primary text-bg rounded hover:bg-primary/80">Reply</button>
                        </div>
                    </div>
                    
                    ${comment.replies.length > 0 ? `
                        <div class="ml-6 mt-4 space-y-4">
                            ${comment.replies.map(reply => `
                                <div class="border-l-2 border-gray-800 pl-4">
                                    <div>
                                        <span class="font-semibold text-secondary text-sm">${reply.author_name}</span>
                                        <span class="text-xs text-gray-500 ml-2">${new Date(reply.created_at).toLocaleString()}</span>
                                    </div>
                                    <p class="text-gray-300 text-sm">${reply.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            container.innerHTML += commentHtml;
        });
    }

    async function toggleLike() {
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}/like`, { method: 'POST' });
            const data = await response.json();
            
            document.getElementById('like-count').textContent = data.like_count;
            const likeBtn = document.getElementById('like-btn').querySelector('svg');
            
            if (data.liked) {
                likeBtn.classList.add('fill-primary', 'text-primary');
            } else {
                likeBtn.classList.remove('fill-primary', 'text-primary');
            }
        } catch (error) {
            alert('Error toggling like');
        }
    }

    async function sharePost() {
        try {
            await authService.apiCall(`/api/v1/posts/${postId}/share`, { method: 'POST' });
            alert('Post shared successfully!');
        } catch (error) {
            alert('Error sharing post');
        }
    }

    document.getElementById('comment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = document.getElementById('comment-content').value.trim();
        if (!content) return;

        try {
            await authService.apiCall(`/api/v1/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            
            document.getElementById('comment-content').value = '';
            loadPost(); // Reload to show new comment
        } catch (error) {
            alert('Error posting comment');
        }
    });

    function showReplyForm(commentId) {
        document.getElementById(`reply-form-${commentId}`).classList.remove('hidden');
    }

    function cancelReply(commentId) {
        document.getElementById(`reply-form-${commentId}`).classList.add('hidden');
    }

    async function postReply(commentId) {
        const content = document.getElementById(`reply-content-${commentId}`).value.trim();
        if (!content) return;

        try {
            await authService.apiCall(`/api/v1/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, parent_id: commentId })
            });
            
            loadPost(); // Reload to show new reply
        } catch (error) {
            alert('Error posting reply');
        }
    }

    async function deletePost() {
        if (!confirm('Are you sure you want to delete this post?')) return;

        try {
            await authService.apiCall(`/api/v1/posts/${postId}`, { method: 'DELETE' });
            window.location.href = '/dashboard';
        } catch (error) {
            alert('Error deleting post');
        }
    }

    document.addEventListener('DOMContentLoaded', loadPost);
</script>
{% endblock %}
