{% extends "base.html" %}

{% block title %}Post - InsightBlog{% endblock %}

{% block content %}
<div class="container container-sm" style="padding: 2rem 0;">
    <!-- Loading -->
    <div id="loading" class="text-center" style="padding: 4rem 0;">
        <div class="skeleton" style="height: 300px; margin-bottom: 2rem;"></div>
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
    </div>

    <!-- Post Content -->
    <div id="post-content" style="display: none;">
        <!-- Back Button -->
        <div style="margin-bottom: 2rem;">
            <a href="/dashboard" class="text-muted" style="text-decoration: none;">
                ← Back to Feed
            </a>
        </div>

        <article class="card">
            <!-- Post Image -->
            <div id="post-image" style="display: none; width: 100%; height: 400px; border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 2rem;">
                <img id="post-img" src="" alt="" style="width: 100%; height: 100%; object-fit: cover;">
            </div>

            <!-- Post Header -->
            <div style="margin-bottom: 2rem;">
                <h1 id="post-title" style="margin-bottom: 1rem;"></h1>
                <div class="flex items-center gap-md text-sm text-muted">
                    <span id="post-author"></span>
                    <span>•</span>
                    <span id="post-date"></span>
                </div>
            </div>

            <!-- Post Summary -->
            <div style="margin-bottom: 2rem;">
                <p id="post-summary" class="text-lg"></p>
            </div>

            <!-- Categories & Tags -->
            <div id="post-categories" class="flex gap-sm" style="margin-bottom: 2rem; flex-wrap: wrap;"></div>

            <!-- Actions -->
            <div style="display: flex; align-items: center; gap: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <button id="like-btn" onclick="toggleLike()" style="display: flex; align-items: center; gap: 0.5rem; background: none; border: none; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; padding: 0.5rem;">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span id="like-count" style="font-size: 0.875rem;">0</span>
                </button>

                <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); padding: 0.5rem;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <span id="comment-count" style="font-size: 0.875rem;">0</span>
                </div>

                <button onclick="sharePost()" style="display: flex; align-items: center; gap: 0.5rem; background: none; border: none; cursor: pointer; color: var(--text-secondary); transition: color 0.2s; padding: 0.5rem;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    <span style="font-size: 0.875rem;">Share</span>
                </button>

                <div id="admin-actions" style="margin-left: auto; display: none;">
                    <button onclick="deletePost()" class="btn btn-secondary" style="background: var(--error); border-color: var(--error);">Delete Post</button>
                </div>
            </div>
        </article>

        <!-- Comments Section -->
        <div class="card" style="margin-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">Comments (<span id="comments-count">0</span>)</h2>

            <form id="comment-form" class="flex flex-col gap-md" style="margin-bottom: 2rem;">
                <textarea id="comment-content" rows="3" placeholder="Write a comment..." class="input"></textarea>
                <div style="display: flex; justify-content: flex-end;">
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </div>
            </form>

            <div id="comments-list" class="flex flex-col gap-md"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const postId = parseInt(window.location.pathname.split('/').pop());
    let postData = null;
    let userLiked = false;

    async function loadPost() {
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}`);
            
            if (!response.ok) {
                throw new Error('Post not found');
            }
            
            postData = await response.json();
            renderPost(postData);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('post-content').style.display = 'block';
        } catch (error) {
            console.error('Error loading post:', error);
            document.getElementById('loading').innerHTML = '<div class="card text-center"><p class="text-error">Error loading post</p></div>';
        }
    }

    function renderPost(post) {
        // API returns: author_name, author_username, author_email
        const title = post.title || 'Untitled Post';
        const authorName = post.author_name || 'Unknown Author';
        const authorUsername = post.author_username || 'unknown';
        const summary = post.summary || '';
        const createdAt = post.created_at || new Date().toISOString();
        
        document.getElementById('post-title').textContent = title;
        
        // Create clickable author link
        const authorElement = document.getElementById('post-author');
        const authorId = post.author_id;
        authorElement.innerHTML = `By <a href="/user/${authorId}" style="color: var(--primary); text-decoration: none; font-weight: 600; transition: color 0.2s;" onmouseover="this.style.color='var(--secondary)'" onmouseout="this.style.color='var(--primary)'">@${authorUsername}</a>`;
        
        document.getElementById('post-date').textContent = new Date(createdAt).toLocaleDateString('en-US', { 
            year: 'numeric', month: 'long', day: 'numeric' 
        });
        document.getElementById('post-summary').textContent = summary;
        document.getElementById('like-count').textContent = post.like_count || 0;
        document.getElementById('comment-count').textContent = post.comment_count || 0;
        document.getElementById('comments-count').textContent = post.comment_count || 0;
        
        userLiked = post.user_liked || false;
        updateLikeButton();
        
        // Show image if available
        if (post.image_url) {
            document.getElementById('post-img').src = post.image_url;
            document.getElementById('post-image').style.display = 'block';
        }
        
        // Render categories
        const categoriesDiv = document.getElementById('post-categories');
        categoriesDiv.innerHTML = '';
        if (post.categories && post.categories.length > 0) {
            post.categories.forEach(cat => {
                const categoryName = typeof cat === 'string' ? cat : (cat.title || cat.name || 'Uncategorized');
                categoriesDiv.innerHTML += `<span class="badge badge-primary">${categoryName}</span>`;
            });
        }
        
        // Render comments
        if (post.comments && post.comments.length > 0) {
            renderComments(post.comments);
        }
    }

    function updateLikeButton() {
        const likeBtn = document.getElementById('like-btn');
        if (userLiked) {
            likeBtn.style.color = 'var(--error)';
        } else {
            likeBtn.style.color = 'var(--text-secondary)';
        }
    }

    async function toggleLike() {
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}/like`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const data = await response.json();
                userLiked = data.liked;
                document.getElementById('like-count').textContent = data.like_count;
                updateLikeButton();
            }
        } catch (error) {
            notificationService.showToast('Error toggling like', 'error');
        }
    }

    async function sharePost() {
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}/share`, {
                method: 'POST'
            });
            
            if (response.ok) {
                notificationService.showToast('Post shared!', 'success');
            }
        } catch (error) {
            notificationService.showToast('Error sharing post', 'error');
        }
    }

    async function deletePost() {
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                notificationService.showToast('Post deleted', 'success');
                setTimeout(() => window.location.href = '/dashboard', 500);
            }
        } catch (error) {
            notificationService.showToast('Error deleting post', 'error');
        }
    }

    function renderComments(comments) {
        const commentsList = document.getElementById('comments-list');
        commentsList.innerHTML = '';
        
        comments.forEach(comment => {
            // API returns: author_name, author_username
            const userName = comment.author_name || 'Anonymous';
            const userUsername = comment.author_username || 'unknown';
            const content = comment.content || '';
            const createdAt = comment.created_at || new Date().toISOString();
            
            const commentHtml = `
                <div class="card" style="padding: 1rem;">
                    <div class="flex gap-md">
                        <div class="avatar avatar-sm">
                            <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=6366f1&color=fff" alt="${userName}">
                        </div>
                        <div style="flex: 1;">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold">
                                        <a href="/user/${comment.author_id}" style="color: var(--text-primary); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-primary)'">${userName}</a>
                                        <span style="color: var(--text-muted); font-weight: normal; font-size: 0.875rem; margin-left: 0.5rem;">@${userUsername}</span>
                                    </p>
                                    <p class="text-sm text-muted">${new Date(createdAt).toLocaleString()}</p>
                                </div>
                            </div>
                            <p style="margin-top: 0.5rem;">${content}</p>
                            ${comment.replies && comment.replies.length > 0 ? renderReplies(comment.replies) : ''}
                        </div>
                    </div>
                </div>
            `;
            commentsList.innerHTML += commentHtml;
        });
    }

    function renderReplies(replies) {
        let html = '<div style="margin-left: 2rem; margin-top: 1rem; padding-left: 1rem; border-left: 2px solid var(--border-color);">';
        replies.forEach(reply => {
            // API returns: author_name, author_username
            const userName = reply.author_name || 'Anonymous';
            const userUsername = reply.author_username || 'unknown';
            const content = reply.content || '';
            const createdAt = reply.created_at || new Date().toISOString();
            
            html += `
                <div style="margin-bottom: 1rem;">
                    <div class="flex gap-sm items-center">
                        <p class="font-semibold text-sm">
                            <a href="/user/${reply.author_id}" style="color: var(--text-primary); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-primary)'">${userName}</a>
                            <span style="color: var(--text-muted); font-weight: normal; margin-left: 0.25rem;">@${userUsername}</span>
                        </p>
                        <p class="text-xs text-muted">${new Date(createdAt).toLocaleString()}</p>
                    </div>
                    <p class="text-sm" style="margin-top: 0.25rem;">${content}</p>
                </div>
            `;
        });
        html += '</div>';
        return html;
    }

    // Comment form submission
    document.getElementById('comment-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const content = document.getElementById('comment-content').value.trim();
        if (!content) return;
        
        try {
            const response = await authService.apiCall(`/api/v1/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content, parent_id: null })
            });
            
            if (response.ok) {
                document.getElementById('comment-content').value = '';
                notificationService.showToast('Comment posted!', 'success');
                loadPost(); // Reload to show new comment
            }
        } catch (error) {
            notificationService.showToast('Error posting comment', 'error');
        }
    });

    document.addEventListener('DOMContentLoaded', loadPost);
</script>
{% endblock %}
