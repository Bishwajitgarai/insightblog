{% extends "base.html" %}

{% block title %}Profile - InsightBlog{% endblock %}

{% block content %}
<div class="container container-sm" style="padding: 2rem 0;">
    <!-- Loading -->
    <div id="loading" class="text-center" style="padding: 4rem 0;">
        <div class="skeleton skeleton-avatar" style="margin: 0 auto 1rem;"></div>
        <div class="skeleton skeleton-title" style="margin: 0 auto 1rem;"></div>
        <div class="skeleton skeleton-text" style="margin: 0 auto;"></div>
    </div>

    <!-- Profile Content -->
    <div id="profile-content" class="card" style="display: none;">
        <div class="text-center" style="margin-bottom: 2rem;">
            <div style="width: 120px; height: 120px; margin: 0 auto 1rem; border-radius: 50%; overflow: hidden; border: 3px solid var(--primary);">
                <img id="profileImage" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff&size=120" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <h2 id="profile-name" style="margin-bottom: 0.5rem;"></h2>
            <p id="profile-email" class="text-muted"></p>
        </div>

        <form id="profileForm" class="flex flex-col gap-md">
            <div>
                <label for="full_name" class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">Full Name</label>
                <input id="full_name" name="full_name" type="text" class="input">
            </div>

            <div>
                <label for="bio" class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">Bio</label>
                <textarea id="bio" name="bio" rows="3" class="input" placeholder="Tell us about yourself"></textarea>
            </div>

            <div>
                <label for="avatarInput" class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">Profile Picture</label>
                <input type="file" id="avatarInput" accept="image/*" class="input">
            </div>

            <button type="submit" class="btn btn-primary">
                Update Profile
            </button>
            
            <button type="button" onclick="toggleChangePasswordModal()" class="btn btn-secondary">
                Change Password
            </button>
        </form>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal-overlay" style="display: none;">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 style="margin: 0;">Change Password</h3>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm" class="flex flex-col gap-md">
                    <div>
                        <label class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">Current Password</label>
                        <input type="password" name="old_password" required class="input">
                    </div>
                    <div>
                        <label class="text-sm font-semibold" style="display: block; margin-bottom: 0.5rem;">New Password</label>
                        <input type="password" name="new_password" required class="input" minlength="6">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="toggleChangePasswordModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="submitPasswordChange()" class="btn btn-primary">Update Password</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;

    async function loadProfile() {
        try {
            const response = await authService.apiCall('/api/v1/users/me');
            if (!response.ok) throw new Error('Failed to load profile');
            
            currentUser = await response.json();
            renderProfile(currentUser);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';
        } catch (error) {
            console.error('Error loading profile:', error);
            document.getElementById('loading').innerHTML = '<p class="text-error">Error loading profile</p>';
        }
    }

    function renderProfile(user) {
        document.getElementById('profile-name').textContent = user.full_name;
        document.getElementById('profile-email').textContent = user.email;
        document.getElementById('full_name').value = user.full_name || '';
        document.getElementById('bio').value = user.bio || '';
        
        if (user.profile_image_url) {
            document.getElementById('profileImage').src = user.profile_image_url;
        } else {
            document.getElementById('profileImage').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.full_name)}&background=6366f1&color=fff&size=120`;
        }
    }

    function toggleChangePasswordModal() {
        const modal = document.getElementById('changePasswordModal');
        if (modal.style.display === 'none') {
            modal.style.display = 'flex';
        } else {
            modal.style.display = 'none';
        }
    }

    // Close modal on overlay click
    document.getElementById('changePasswordModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('changePasswordModal')) {
            toggleChangePasswordModal();
        }
    });

    // Avatar Upload
    document.getElementById('avatarInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await authService.apiCall('/api/v1/users/me/avatar', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('profileImage').src = data.profile_image_url;
                notificationService.showToast('Avatar updated successfully!', 'success');
            }
        } catch (error) {
            notificationService.showToast('Error uploading avatar', 'error');
        }
    });

    // Profile Update
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            full_name: document.getElementById('full_name').value,
            bio: document.getElementById('bio').value
        };

        try {
            const response = await authService.apiCall('/api/v1/users/me', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                notificationService.showToast('Profile updated successfully!', 'success');
                loadProfile();
            }
        } catch (error) {
            notificationService.showToast('Error updating profile', 'error');
        }
    });

    // Change Password
    async function submitPasswordChange() {
        const form = document.getElementById('changePasswordForm');
        const formData = new FormData(form);
        
        const data = {
            old_password: formData.get('old_password'),
            new_password: formData.get('new_password')
        };

        try {
            const response = await authService.apiCall('/api/v1/users/me/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                notificationService.showToast('Password changed successfully!', 'success');
                toggleChangePasswordModal();
                form.reset();
            } else {
                const errorData = await response.json();
                notificationService.showToast(errorData.detail || 'Failed to change password', 'error');
            }
        } catch (error) {
            notificationService.showToast('Error changing password', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}
